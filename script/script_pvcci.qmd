---
title: "Join PVCCI to GADM 4.10"
format: html
editor: visual
---

```{r}
#pckg
library(sf)
library(tidyverse) # dplyr # readr # purrr
library(janitor)
library(stringi)
library(countrycode)
library(fuzzyjoin)   # stringdist
```

# GADM 4.10

## Import ADM0/1/2

```{r}

## load gadm source data
# adm0
adm0_gadm_410 <- read_sf('C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_410-levels/gadm_410-levels.gpkg', layer ='ADM_0') |> 
  clean_names() |> 
  mutate(gid_0 = ifelse(gid_0 == 'XKO', 'XKX', gid_0)) |> 
  # filter(!gid_0 == 'ALA') |> # remove åland, as part of finland
  rename(iso3 = gid_0)

# adm1
adm1_gadm_410 <- read_sf('C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_410-levels/gadm_410-levels.gpkg', layer ='ADM_1') |> 
  clean_names() |> 
  mutate(gid_0 = ifelse(gid_0 == 'XKO', 'XKX', gid_0)) |> 
  # filter(!gid_0 == 'ALA') |> # remove åland, as part of finland
  rename(iso3 = gid_0)

#adm2
adm2_gadm_410 <- read_sf('C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_410-levels/gadm_410-levels.gpkg', layer ='ADM_2') |> 
  clean_names() |> 
  mutate(gid_0 = ifelse(gid_0 == 'XKO', 'XKX', gid_0)) |> 
  # filter(!gid_0 == 'ALA') |> # remove åland, as part of finland
  rename(iso3 = gid_0)

#adm3
# adm3_gadm_410 <- read_sf('C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_410-levels/gadm_410-levels.gpkg', layer ='ADM_3') |> 
#   clean_names() |> 
#   mutate(gid_0 = ifelse(gid_0 == 'XKO', 'XKX', gid_0)) |> 
#   # filter(!gid_0 == 'ALA') |> # remove åland, as part of finland
#   rename(iso3 = gid_0)

# missing adm data
# adm1_gadm |> filter(!iso3 %in% unique(adm2_gadm$iso3))
# adm0_gadm |> filter(!iso3 %in% c(unique(adm2_gadm$iso3), unique(adm1_gadm$iso3)))
```

## Clean ADM2

```{r}

# adm2_gadm_clean <- st_read('C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_410-gpkg/adm2_gadm_clean.gpkg')

adm2_gadm_410_clean <- adm2_gadm_410 |>
  # if not adm2 data, use adm1 data
  bind_rows(adm1_gadm_410 |> filter(!iso3 %in% unique(adm2_gadm_410$iso3))) |>
  # finally, if not in either adm2 or adm1, use adm0
  bind_rows(adm0_gadm_410 |> filter(!iso3 %in% c(unique(adm2_gadm_410$iso3), unique(adm1_gadm_410$iso3)))) |>
  mutate(across(c(name_1, name_2), \(x) na_if(x, "?"))) |> 
  mutate(name_adm2 = ifelse(is.na(name_2) & is.na(name_1), country,
                         ifelse(is.na(name_2), name_1, name_2) )) |>
  mutate(gid_adm2 = ifelse(is.na(gid_2) & is.na(gid_1), iso3,
                        ifelse(is.na(gid_2), gid_1, gid_2))) |>
  select(country, iso3, 
         gid_adm1 = gid_1, name_adm1 = name_1, 
         gid_adm2, name_adm2, hasc_2) |> 
  # some of the adm1 levels are divided to those that are officially in a country and those that are
  # on conflict zones (between CHN, IND and PAK)
  # let's rename them with those that we have data for
  mutate(iso3 = ifelse(
    iso3 %in% c('Z02', 'Z03', 'Z08'),'CHN',
    ifelse(iso3 %in% c('Z06'), 'PAK',
           ifelse(iso3 %in% c('Z01', 'Z04','Z05','Z07','Z09'), 'IND',
                                     iso3))))

# NOTE: Macao and Hong Kong are misssing in GADM .gpkg file, not sure why

st_write(adm2_gadm_410_clean, 
         'C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/adm2_gadm_clean.gpkg', delete_dsn=T)
```

# GADM 3.6

```{r}

adm2_gadm_36 <- st_read("C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_36_adm2/gadm_36_adm2.shp") |>
  clean_names() |> 
  select(iso3 = iso, name_0, name_1, name_2, hasc_2, idcomp, surface)

# Download from https://gadm.org/data.html failed
# usethis::use_zip(
# url = "https://biogeo.ucdavis.edu/data/gadm3.6/gadm36_gpkg.zip",
# destdir = "C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_36_adm2"
# )
```

## Assign GADM 4.1 to GADM 3.6 ADM-2

```{r}

# create ID based on row numbers
g36_start <- adm2_gadm_36 |> mutate(g36_id = row_number())
g410_start <- adm2_gadm_410_clean |> mutate(g410_id = row_number())

g36 <- g36_start |> st_set_geometry(NULL)
g410 <- g410_start |> st_set_geometry(NULL)

# saveRDS(g36, g410, file = "C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_36_410.RDS")
# readRDS("C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/gadm_36_410.RDS")
```

```{r}

# make adm names comparable
clean_string <- function(x){
  x <- ifelse(is.na(x),"", as.character(x))
  x <- str_to_lower(x)
  x <- stringi::stri_trans_general(x, "Latin-ASCII")     # remove accents
  x <- str_replace_all(x, "[^a-z0-9 ]+", " ")
  x <- str_squish(x)
  x[x==""] <- NA
  x
}

g36 <- g36 |>
  mutate(
    adm0 = name_0,
    adm1 = name_1,
    adm2 = name_2,
    adm0_n = clean_string(adm0),
    adm1_n = clean_string(adm1),
    adm2_n = clean_string(adm2),
    hasc  = as.character(hasc_2)
  )

g410 <- g410 |>
  mutate(
    adm0 = country,
    adm1 = name_adm1,
    adm2 = name_adm2,
    adm0_n = clean_string(adm0),
    adm1_n = clean_string(adm1),
    adm2_n = clean_string(adm2),
    hasc  = as.character(hasc_2)
  )
```

```{r}

g36 <- g36 |> 
  mutate(adm0 = case_when(
    iso3 == "CIV" ~ "Cote d'Ivoire",
    iso3 == "STP" ~ "Sao Tome and Principe",
    iso3 == "ALA" ~ "Aland",
    TRUE ~ name_0
  )) |>
  mutate(iso3c = countrycode(adm0, 
                             origin = 'country.name', destination = 'iso3c',
                             custom_match = c(
                               "Kosovo" = "XKX",
                               "Akrotiri and Dhekelia" = "XAD",
                               "Micronesia" = "FSM"
                               )))
  # |> distinct(adm0, iso3, iso3c) |> 
  # filter(is.na(iso3c))

g410 <- g410 |> 
  mutate(across(c(adm0, iso3), ~ na_if(.x, "NA"))) |> 
  mutate(iso3c = countrycode(adm0, 
                             origin = 'country.name', destination = 'iso3c',
                             custom_match = c(
                               "Micronesia" =	"FSM",
                               "México" =	"MEX",
                               "Kosovo"	= "XKX",
                               "United States Minor Outlying Isl"	= "UMI",
                               "Akrotiri and Dhekelia" = "XAD",
                               "Saint-Martin"	= "MAF",
                               "Caspian Sea"	= "XCA",
                               "Clipperton Island"	= "XCL",
                               "Paracel Islands"	= "XPI",
                               "Spratly Islands"	= "XSP"
                             )))
  # |> distinct(adm0, iso3, iso3c) |> 
  # filter(is.na(iso3c))
```

```{r}

# replace missing values hasc_2 by NA
g36 <- g36 |> 
  mutate(hasc = case_when(
    hasc=="NA" ~ NA,
    hasc=="#N/A" ~ NA,
    hasc=="unknown" ~ NA,
    hasc=="<Null>" ~ NA,
    .default = hasc))

g410 <- g410 |> 
  mutate(hasc = case_when(
    hasc=="NA" ~ NA,
    hasc=="#N/A" ~ NA,
    hasc=="unknown" ~ NA,
    hasc=="?" ~ NA,
    .default = hasc))
```

### HASC matching

```{r exact_hasc_matches}

# identify duplicates in each set
dup36 <- g36 |> count(hasc) |> filter(!is.na(hasc) & n>1)
dup410  <- g410 |> count(hasc) |> filter(!is.na(hasc) & n>1)

# Plot duplicates
# plot(st_geometry(g36[g36$iso3=="AFG",]),
#      col = ifelse(g36$hasc_2 == "AF.BD.FA", "red", "lightgrey"))

# unique-by-hasc subsets
g36_hasc_unique <- g36 |> 
  filter(!is.na(hasc) & !hasc %in% dup36$hasc)
g410_hasc_unique <- g410 |> 
  filter(!is.na(hasc) & !hasc %in% dup410$hasc)

# match with gadm410
exact_hasc_matches <- inner_join(
  g36_hasc_unique,
  g410_hasc_unique,
  by = "hasc"
) |> 
  transmute(
    g36_id, g410_id,
    hasc,
    match_type = "exact_hasc")

g36 <- filter(g36, !g36_id %in% exact_hasc_matches$g36_id)
g410 <- filter(g410, !g410_id %in% exact_hasc_matches$g410_id)
```

### Full name matching

```{r full_name_matches}

# exact name matches on cleaned strings
full_name_matches <- inner_join(g36 |> 
                                   select(g36_id, iso3c, adm1_n, adm2_n), 
                                 g410 |> 
                                   select(g410_id, iso3c, adm1_n, adm2_n), 
                                 by = c("iso3c", "adm1_n", "adm2_n"),
                                 relationship = "many-to-many") |> 
  transmute(
    g36_id, g410_id,
    match_type = "full_name")

g36 <- filter(g36, !g36_id %in% full_name_matches$g36_id)
g410 <- filter(g410, !g410_id %in% full_name_matches$g410_id)
```

### Fuzzy name matching

```{r exact_fuzzy}

## fuzzy name matching

# define thresholds
thresholds <- c(0.1, 0.15, 0.2)

fuzzy_matches_list <- lapply(thresholds, function(thresh){
  stringdist_inner_join(
    g36 |> select(g36_id, iso3c, adm1_n, adm2_n),
    g410 |> select(g410_id, iso3c, adm1_n, adm2_n),
    by = c("iso3c", "adm1_n", "adm2_n"),
    method = "jw",
    max_dist = thresh,
    distance_col = "dist"
  ) |> 
    transmute(
      g36_id,
      g410_id,
      iso3c.x, adm1_n.x, adm2_n.x,
      iso3c.y, adm1_n.y, adm2_n.y,
      match_type = paste0("fuzzy_name_", thresh),
      iso3c.dist, adm1_n.dist, adm2_n.dist
    )
})

# aggregate and order by threshold
fuzzy_matches <- bind_rows(fuzzy_matches_list) |> 
  group_by(g36_id, g410_id) |> 
  arrange(match_type) |> 
  slice_min(match_type, with_ties = FALSE) |> # 1 wins over 1.5 that wins over 2
  ungroup() |> 
  mutate(n_matches_split = n(), .by = c(g36_id, match_type)) |> 
  mutate(n_matches_merge = n(), .by = c(g410_id, match_type)) |> 
  mutate(many_to_many = n_matches_merge > 1 | n_matches_split > 1)

save(fuzzy_matches_list, fuzzy_matches, file = "C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/fuzzy_matches.RData")
# load("C:/Users/pauvernu/Seafile/library/chap_two_data/gadm/fuzzy_matches.RData")

# exact fuzzy: matches w/out duplicate
exact_fuzzy_match <- filter(fuzzy_matches, many_to_many==FALSE) |> 
  transmute(
    g36_id, g410_id,
    match_type)

g36 <- filter(g36, !g36_id %in% exact_fuzzy_match$g36_id)
g410 <- filter(g410, !g410_id %in% exact_fuzzy_match$g410_id)
```

```{r}

# fuzzy matches w/ duplicates, but exact matching at adm2 level
adm2_fuzzy_match <- filter(fuzzy_matches, many_to_many==TRUE, adm2_n.dist==0) |> 
  transmute(
    g36_id, g410_id,
    match_type)

g36 <- filter(g36, !g36_id %in% adm2_fuzzy_match$g36_id)
g410 <- filter(g410, !g410_id %in% adm2_fuzzy_match$g410_id)
```

```{r}

g36 |> group_by(iso3c, adm0) |> tally() |> arrange(desc(n))
g410 |> group_by(iso3c, adm0) |> tally() |> arrange(desc(n))
```

### Spatial matching

```{r unmatched_sf}

g36_sf <- left_join(g36,
                    select(g36_start, g36_id, geometry),
                    by = "g36_id") |> 
  st_as_sf()

g410_sf <- left_join(g410,
                     select(g410_start, g410_id, geometry = geom),
                     by = "g410_id") |> 
  st_as_sf()
  
countries <- intersect(g36_sf$iso3c, g410_sf$iso3c)
length(countries)
```

```{r compute_overlap_country}

compute_overlap_country <- function(iso_code) {

  message("Processing: ", iso_code)

  g36_iso  <- g36_sf |> filter(iso3c == iso_code)
  g410_iso <- g410_sf |> filter(iso3c == iso_code)

  if (nrow(g36_iso) == 0 || nrow(g410_iso) == 0) return(NULL)

  # Project to metric CRS
  g36p  <- st_transform(g36_iso, 3857)
  g410p <- st_transform(g410_iso, 3857)

  # Candidate list (sparse)
  cand_list <- st_intersects(g36p, g410p, sparse = TRUE)

  # Fast helper for pairs
  compute_pair <- function(i, j) {
    a <- g36p[i, , drop = FALSE]
    b <- g410p[j, , drop = FALSE]
    inter <- tryCatch(st_intersection(a$geometry, b$geometry), error = function(e) NULL)

    inter_area <- if (is.null(inter) || length(inter) == 0) 0 else {
      x <- as.numeric(st_area(inter))
      sum(x, na.rm = TRUE)
    }

    g36_area  <- as.numeric(st_area(a))
    g410_area <- as.numeric(st_area(b))

    tibble(
      iso3c      = iso_code,
      g36_id    = a$g36_id,
      g410_id   = b$g410_id,
      inter_area = inter_area,
      g36_area  = g36_area,
      g410_area = g410_area,
      overlap_ratio_g36  = ifelse(g36_area > 0, inter_area / g36_area, 0),
      overlap_ratio_g410 = ifelse(g410_area > 0, inter_area / g410_area, 0)
    )
  }

  idx <- which(lengths(cand_list) > 0)

  map_dfr(idx, function(i) {
    js <- cand_list[[i]]
    map_dfr(js, function(j) compute_pair(i, j))
  })
}
```

```{r}

# apply function over countries
overlap_country_list <- future_lapply(countries, compute_overlap_country,
                                      future.seed = TRUE)

overlap_tbl <- bind_rows(overlap_country_list) |>
  filter(inter_area > 0) |>
  arrange(iso3c, g36_id, desc(overlap_ratio_g36))
```

```{r}

# Mutual overlap
common_overlap_match <- overlap_tbl |> 
  filter(overlap_ratio_g36 >= .9 & overlap_ratio_g410 >= .9) |> 
  transmute(
    g36_id, g410_id,
    match_type = "common overlap"    
  )

g36 <- filter(g36, !g36_id %in% common_overlap_match$g36_id)
g410 <- filter(g410, !g410_id %in% common_overlap_match$g410_id)
```

```{r}

# g410 area fully overlap by g36 area
# best situation, 100% g36 value assigned to g410
g410_overlap_match <- overlap_tbl |> 
  filter(g36_id %in% g36$g36_id, g410_id %in% g410$g410_id) |> 
  filter(overlap_ratio_g410 >= .9) |> 
  transmute(
    g36_id, g410_id,
    match_type = "g410 overlap"
  )

g410_overlap_match |> get_dupes(g410_id)

g36 <- filter(g36, !g36_id %in% g410_overlap_match$g36_id)
g410 <- filter(g410, !g410_id %in% g410_overlap_match$g410_id)
```

```{r}

# g36 area fully overlap by g410 area
# more complicated: weighted average based on area
# option: (i) sum total share of g410 area covered by g36 areas, (ii) if above threshold, e.g. .8, assign weighted average: sum(g36_area * overlap_ratio_g410)
g36_overlap <- overlap_tbl |> 
  filter(g36_id %in% g36$g36_id, g410_id %in% g410$g410_id) |> 
  filter(overlap_ratio_g36 >= .9)

g36_overlap |> get_dupes(g36_id)

g36_overlap_match <- g36_overlap |> 
  mutate(total_overlap_ratio = sum(overlap_ratio_g410, na.rm = T), 
         .by = g410_id) |> 
  # arrange(desc(total_overlap_ratio)) |> 
  mutate(thres = ifelse(total_overlap_ratio > .8, 1, 0)) |> 
  filter(thres > 0) |> 
  # mutate(weight = overlap_ratio_g410) |> 
  arrange(g410_id) |> 
  transmute(
    g36_id, g410_id, 
    weight = overlap_ratio_g410,
    match_type = "g36 overlap"
  )

g36 <- filter(g36, !g36_id %in% g36_overlap_match$g36_id)
g410 <- filter(g410, !g410_id %in% g36_overlap_match$g410_id)
```

```{r}

# Map example: Mexico
id <- overlap_tbl |>
  # filter(g36_id %in% g36$g36_id, g410_id %in% g410$g410_id) |> 
  filter(iso3c=="GHA")

sf36 <- filter(g36_sf, g36_id %in% id$g36_id)
sf410 <- filter(g410_sf, g410_id %in% id$g410_id)

ggplot() +
  geom_sf(data = sf36, fill = "blue", alpha = 0.1) +
  geom_sf(data = sf410, fill = "yellow", alpha = 0.1) +   
  theme_minimal()
```

```{r}
g36 |> 
  group_by(iso3c, adm0) |> 
  tally() |> 
  ungroup() |> 
  mutate(share = n / sum(n)) |> 
  arrange(desc(n))

g410 |> 
  group_by(iso3c, adm0) |> 
  tally() |> 
  ungroup() |> 
  mutate(share = n / sum(n)) |> 
  arrange(desc(n))
```

```{r}

# stack all matches
matches <- bind_rows(
  exact_hasc_matches,
  full_name_matches,
  exact_fuzzy_match,
  adm2_fuzzy_match
) |> 
  arrange(match_type)  # exact_hasc > exact_name > fuzzy
```

# PVCCI

```{r}

# read data
pvcci_subnational <- readxl::read_excel("C:/Users/pauvernu/Seafile/library/chap_two_data/20251008_pvcci_os.xlsx") |> 
  clean_names() |> 
  mutate(across(c(name_0, name_1, name_2), \(x) na_if(x, "0"))) |> 
  mutate(iso = case_when( # iso w/ different iso code in gadm
    iso == "XKO" ~ "XKX",
    iso == "XNC" ~ "ZNC",
    .default = iso
  )) |>   
  filter(!iso %in% c("SP-", "PIS")) |> # iso w/ no value (probably typos)
  rename(iso3 = iso, name_adm0 = name_0, name_adm1 = name_1, name_adm2 = name_2) |> 
  as_tibble()

# create new variables (agg w/ quadratic mean)
pvcci <- pvcci_subnational |> 
  mutate(
    fast_onset_pvcci = sqrt((flood_norm^2 + aridity_norm^2) / 2),
    slow_onset_pvcci = sqrt((rainfall_norm^2 + temperature_norm^2 + storms_norm^2) / 3)
  )
```
